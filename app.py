from flask import Flask, request, jsonify, render_template, send_from_directory
from PIL import Image, ImageDraw, ImageFont
import os
import time

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏≤‡∏ò‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
BASE_DIR = os.path.dirname(os.path.abspath(__file__)) 

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Flask App
app = Flask(__name__)

# --- ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ---
TEMPLATE_IMAGE_PATH = os.path.join(BASE_DIR, 'template.png')
OUTPUT_DIR_NAME = 'generated_images'
OUTPUT_DIR = os.path.join(BASE_DIR, OUTPUT_DIR_NAME)

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
if not os.path.exists(OUTPUT_DIR): 
    os.makedirs(OUTPUT_DIR, exist_ok=True) 

# üö® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô None ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Pillow ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå‡∏ö‡∏ô Cloud
DEFAULT_FONT_PATH = None 
DEFAULT_FONT_SIZE = 60
# -----------------------------------

@app.route('/')
def index():
    return render_template('index.html') 


# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏µ #RRGGBB ‡πÄ‡∏õ‡πá‡∏ô Tuple (R, G, B)
def hex_to_rgb(hex_color):
    hex_color = hex_color.lstrip('#')
    return tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))


@app.route('/generate-image', methods=['POST'])
def generate_image():
    # 1. ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Front-end
    try:
        data = request.get_json()
        user_text = data.get('user_text', '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤')
        font_size = int(data.get('font_size', DEFAULT_FONT_SIZE))
        text_align = data.get('text_align', 'left')
        bg_color_hex = data.get('bg_color', 'template')
        text_color_hex = data.get('text_color', '#000000')

    except Exception as e:
         return jsonify({"error": f"‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (JSON) ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: {str(e)}"}), 400
    
    # 2. ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô
    try:
        if bg_color_hex == 'template':
            img = Image.open(TEMPLATE_IMAGE_PATH).convert("RGBA")
            width, height = img.size
        else:
            width, height = 1000, 600 
            img = Image.new('RGBA', (width, height), hex_to_rgb(bg_color_hex) + (255,))
    except FileNotFoundError:
        # ‡∏ö‡∏ô Cloud, ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ template.png ‡∏ñ‡∏π‡∏Å Upload ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
        return jsonify({"error": f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå Template: template.png. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö!"}), 500
    except Exception as e:
        return jsonify({"error": f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û: {str(e)}"}), 500

    draw = ImageDraw.Draw(img)
    
    # 3. ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå (‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ö‡∏ô Cloud OS)
    try:
        if DEFAULT_FONT_PATH:
            FONT = ImageFont.truetype(DEFAULT_FONT_PATH, size=font_size) 
        else:
             raise IOError("Using default font path.") 
    except IOError:
        # ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå‡∏Ç‡∏≠‡∏á Pillow (‡∏ö‡∏ô Cloud Host ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
        FONT = ImageFont.load_default() 
    
    text_color_rgb = hex_to_rgb(text_color_hex)
    
    # 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    try:
        # Pillow ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        bbox = draw.textbbox((0, 0), user_text, font=FONT)
        text_width = bbox[2] - bbox[0]
        text_height = bbox[3] - bbox[1]

    except Exception:
        text_width, text_height = font_size * len(user_text) * 0.5, font_size * 1.2 

    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì X ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    margin = 50 
    if text_align == 'center':
        position_x = (width - text_width) / 2
    elif text_align == 'right':
        position_x = width - text_width - margin
    else: 
        position_x = margin
    
    # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Y ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û 
    position_y = (height - text_height) / 2
    
    # 5. ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡∏ö‡∏ô‡∏†‡∏≤‡∏û
    draw.text((position_x, position_y), user_text, font=FONT, fill=text_color_rgb)
    
    # 6. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    output_filename = f"result_{int(time.time())}_{os.getpid()}.png"
    output_path = os.path.join(OUTPUT_DIR, output_filename)
    
    try:
        img.save(output_path)
    except Exception as e:
        return jsonify({"error": f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏î‡πâ: {str(e)}"}), 500
    
    # 7. ‡∏™‡πà‡∏á URL ‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
    image_url = f"/images/{output_filename}" 
    return jsonify({"image_url": image_url})


# Route ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ Front-end ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
@app.route('/images/<filename>')
def serve_generated_image(filename):
    # ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Cloud, ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå generated_images
    return send_from_directory(OUTPUT_DIR, filename)

# üö® ‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (if __name__ == '__main__':) ‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
